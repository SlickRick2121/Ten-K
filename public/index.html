<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farkle With Friends</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chat.css">
    <script src="/socket.io/socket.io.js"></script>
    <script type="importmap">
        {
            "imports": {
                "@discord/embedded-app-sdk": "/libs/@discord/embedded-app-sdk/output/index.mjs",
                "three": "/libs/three/build/three.module.js",
                "three/addons/": "/libs/three/examples/jsm/",
                "cannon-es": "/libs/cannon-es/dist/cannon-es.js",
                "gsap": "/libs/gsap/index.js",
                "gsap/ScrollTrigger": "/libs/gsap/ScrollTrigger.js",
                "gsap/MotionPathPlugin": "/libs/gsap/MotionPathPlugin.js"
            }
        }
    </script>
</head>

<body>
    <div id="global-error-display" style="
        display: none; 
        position: fixed; 
        top: 0; left: 0; right: 0; 
        background: #7f1d1d; 
        color: white; 
        padding: 1rem; 
        z-index: 9999; 
        font-family: monospace; 
        font-size: 12px;
        white-space: pre-wrap;
    "></div>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const el = document.getElementById('global-error-display');
            if (el) {
                el.style.display = 'block';
                el.textContent += `Error: ${msg}\nAt: ${url}:${line}:${col}\n\n`;
            }
        };
        window.addEventListener('unhandledrejection', function (event) {
            const el = document.getElementById('global-error-display');
            if (el) {
                el.style.display = 'block';
                el.textContent += `Promise Rejection: ${event.reason}\n\n`;
            }
        });
    </script>

    <div id="app">
        <div id="bg-dice-container"></div>
        <header class="game-header">
            <div class="logo-container">
                <h1 class="logo-text">Farkle</h1>
                <div class="tagline">
                    <span class="arrow-icon">↳</span> BY VELARIX
                </div>
            </div>
            <button id="rules-btn" class="icon-btn" aria-label="Rules">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
            <button id="settings-btn" class="icon-btn" aria-label="Settings" style="margin-left: 0.5rem;"
                title="Settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
            <button id="chat-toggle-btn" class="icon-btn" aria-label="Chat" style="margin-left: 0.5rem;"
                title="Group Chat">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>
            <button id="leave-btn" class="icon-btn" aria-label="Leave Game" style="margin-left: 0.5rem;"
                title="Leave Table">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span style="font-size: 0.7rem; font-weight: 800; margin-left: 4px; display: none;"
                    id="leave-text">LEAVE</span>
            </button>
        </header>

        <main class="game-board">
            <div id="game-info-bar"
                style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                <span id="room-display"></span>
                <span id="spectator-display"></span>
            </div>
            <div class="player-zones" id="player-zones-container">
                <!-- Players injected via JS -->
            </div>

            <div class="dice-arena">
                <div id="three-canvas-container"></div>
                <div id="dice-container" class="dice-container">
                    <!-- Dice will be injected here (2D fallback/selection) -->
                </div>
                <div id="feedback-message" class="feedback-message hidden">Farkle!</div>
            </div>

            <div class="controls">
                <div class="current-action-info">
                    <span id="action-text">Roll to start your turn</span>
                    <span id="current-score-display">Roll Score: 0</span>
                </div>
                <div class="button-group">
                    <button id="roll-btn" class="btn primary">Roll Dice</button>
                    <button id="bank-btn" class="btn secondary" disabled>Bank Score</button>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div id="rules-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Rules</h2>
                <div class="rules-text">
                    <p><strong>Farkle Rules Summary</strong></p>
                    <p>Begin your turn by rolling all six dice. Check to see if you have rolled any scoring dice or
                        combinations. Set aside any scoring dice you wish, but you must set aside at least one scoring
                        die if possible.</p>
                    <p>After each roll, you may reroll all the dice that have not been set aside or you can choose to
                        bank any accumulated points and end your turn.</p>
                    <p>If all six dice have been set aside for scoring (Hot Dice), you can use them all to continue
                        rolling as normal or you can bank your points and end your turn.</p>
                    <p>You farkle if you roll the dice and score no points with any of them. This ends your turn
                        immediately and all of your points gained so far this turn are lost.</p>
                    <p>At the end of your turn, your score is banked. The first player to reach the winning score
                        (Standard: 10,000) triggers the final round.</p>
                    <br>
                    <p style="color: var(--primary);"><em>Note: Different tables may have different rules (e.g. High
                            Stakes, Welfare Mode). Check the table description!</em></p>
                </div>
                <button class="btn close-modal">Close</button>
            </div>
        </div>

        <div id="setup-modal" class="modal">
            <div class="modal-content">
                <div class="logo-container" style="align-items: center; margin-bottom: 2rem;">
                    <h1 class="logo-text" style="font-size: 4rem !important;">Farkle</h1>
                    <div class="tagline">READY TO ROLL?</div>
                </div>

                <div id="connection-debug"
                    style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">
                    Initializing...</div>

                <div id="mode-selection" style="display:none; text-align: center; margin-bottom: 2rem;">
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">Select Experience</p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button id="mode-casual-btn" class="btn secondary" style="min-width: 120px;">
                            <span style="display:block; font-size: 1.2rem;">☕</span>
                            Casual
                        </button>
                        <button id="mode-speed-btn" class="btn secondary" style="min-width: 120px;">
                            <span style="display:block; font-size: 1.2rem;">⚡</span>
                            Speed Run
                        </button>
                    </div>
                </div>

                <div id="room-list-container" class="room-grid"
                    style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; width: 100%; display: none;">
                    <p style="color:var(--text-muted); font-size: 0.9rem; text-align: center;">Loading tables...</p>
                    <!-- Room List will be injected here -->
                </div>

                <button id="start-game-btn" class="btn primary" disabled style="display: none;"></button>
            </div>
        </div>

        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Settings</h2>
                <div class="input-group">
                    <label>Felt Color</label>
                    <div class="theme-options">
                        <button class="theme-btn" data-theme="green" style="background: #0f3d24;"></button>
                        <button class="theme-btn" data-theme="blue" style="background: #1e3a8a;"></button>
                        <button class="theme-btn" data-theme="red" style="background: #7f1d1d;"></button>
                        <button class="theme-btn" data-theme="purple" style="background: #581c87;"></button>
                    </div>
                </div>
                <div class="input-group">
                    <label>Dice Theme</label>
                    <select id="dice-theme-select">
                        <option value="classic">Classic White</option>
                        <option value="gold">Luxury Gold</option>
                        <option value="dark">Midnight Black</option>
                        <option value="neon">Neon Cyber</option>
                    </select>
                </div>
                <button class="btn close-modal">Close</button>
            </div>
        </div>

        <div id="game-over-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Game Over!</h2>
                <p id="winner-text">Player 1 Wins!</p>
                <div class="final-scores">
                    <div class="final-score-row">
                        <span id="end-p1-name"></span>: <span id="end-p1-score"></span>
                    </div>
                    <div class="final-score-row">
                        <span id="end-p2-name"></span>: <span id="end-p2-score"></span>
                    </div>
                </div>
                <button id="restart-btn" class="btn primary">Play Again</button>
            </div>
        </div>

        <div id="chat-panel" class="chat-panel hidden">
            <div class="chat-header">
                <h3>Group Chat</h3>
                <button id="chat-close-btn" class="icon-btn micro" style="width:30px; height:30px;">✕</button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <!-- Messages -->
                <div class="chat-msg system">Welcome to the chat!</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Say something..." maxlength="100">
                <button id="chat-send-btn" class="btn primary small"
                    style="min-width: 60px; height: 40px; font-size: 0.9rem; padding: 0 15px;">Send</button>
            </div>
        </div>
        <footer
            style="text-align: center; padding: 0.5rem; color: var(--text-muted); font-size: 0.7rem; flex-shrink: 0;">
            <p>
                <a href="privacy.html" style="color: var(--text-muted); text-decoration: none;">Privacy Policy</a> |
                <a href="terms.html" style="color: var(--text-muted); text-decoration: none;">Terms of Service</a>
            </p>
        </footer>
    </div>

    <!-- iOS Style Chat Notifications Container -->
    <div id="chat-notifications" class="chat-notifications-container"></div>

    <script type="module" src="client.js"></script>
</body>

</html>